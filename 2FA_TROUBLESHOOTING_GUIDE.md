# 2FA Troubleshooting Guide

## Problem: Not Receiving 2FA Codes

### Understanding the Issue

When you enable 2FA, you should:
1. See a QR code that you scan with an authenticator app (like Google Authenticator)
2. **NOT receive codes via email or SMS** - codes are generated by your authenticator app

This is a common point of confusion. 2FA codes are **NOT sent to you** - they're generated locally by your authenticator app using a secret stored in your database.

## What Changed

I've fixed the 2FA implementation by:

### 1. Created Server-Side API (`app/api/2fa/route.ts`)
   - Moves all 2FA operations to the server (where `speakeasy` and `qrcode` libraries can run)
   - Client-side browsers can't use these libraries properly

### 2. Updated Client Service (`lib/two-factor-service.ts`)
   - Now calls the API instead of trying to run server-side code in the browser
   - All operations go through the new `/api/2fa` endpoint

## How 2FA Actually Works

### Standard TOTP (Time-based One-Time Password) Flow:

1. **Setup Phase**:
   - Server generates a unique secret key
   - Secret is displayed as a QR code
   - User scans QR code with authenticator app (Google Authenticator, Authy, etc.)
   - Authenticator app stores the secret locally

2. **Verification Phase**:
   - User needs to log in
   - Authenticator app generates a 6-digit code based on:
     - The secret (stored in app)
     - Current time
     - A mathematical algorithm (HMAC-SHA1)
   - User enters this code
   - Server verifies the code using the same secret

3. **Backup Codes**:
   - Additional one-time use codes
   - For emergency access if you lose your device
   - Showed during setup - **SAVE THESE!**

## Testing the Fix

### Step 1: Check Database Schema
Run this SQL in your Supabase SQL editor:
```sql
-- Check if 2FA columns exist
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'user_profiles' 
AND column_name IN ('two_factor_secret', 'two_factor_enabled', 'backup_codes');
```

If columns don't exist, run:
```bash
# Run the 2FA setup script
psql your-db-url -f scripts/055_create_2fa_system.sql
```

### Step 2: Install Dependencies
```bash
npm install speakeasy qrcode
```

### Step 3: Test the Flow

1. **Start your dev server**:
   ```bash
   npm run dev
   ```

2. **Navigate to Account Settings**:
   - Go to `/account`
   - Find the Two-Factor Authentication section

3. **Enable 2FA**:
   - Click "Set Up 2FA"
   - Click "Generate QR Code"
   - You should see a QR code appear

4. **Use Your Authenticator App**:
   - **Download** Google Authenticator or Authy on your phone
   - **Scan** the QR code with your app
   - Your app will start showing 6-digit codes that change every 30 seconds

5. **Verify**:
   - Enter a code from your authenticator app
   - Click "Verify & Enable"

## Common Issues

### Issue: "Failed to generate 2FA secret"
**Solution**: Check browser console for errors. Make sure:
- API route is accessible (`/api/2fa`)
- Server is running
- `speakeasy` and `qrcode` packages are installed

### Issue: "Invalid verification code"
**Possible causes**:
1. **Time sync**: Your device time must be accurate. Enable "Automatic date & time" in your phone settings
2. **Wrong code**: Make sure you're entering the CURRENT code (they change every 30 seconds)
3. **Already used**: Backup codes can only be used once

### Issue: QR Code Not Showing
**Check**:
- Open browser DevTools console - look for errors
- Check if API is responding: `curl http://localhost:3000/api/2fa` (should return 400 - missing params)
- Verify `qrcode` package is installed

### Issue: "User profile not found"
**Solution**: 
- Your user needs a profile record in `user_profiles` table
- This should be auto-created on signup
- Check with:
  ```sql
  SELECT * FROM user_profiles WHERE user_id = 'your-user-id';
  ```

## Manual Database Check

If you're still having issues, check the database directly:

```sql
-- Check your 2FA setup
SELECT 
  user_id,
  two_factor_enabled,
  two_factor_secret IS NOT NULL as has_secret,
  array_length(backup_codes, 1) as backup_codes_count,
  last_2fa_verification
FROM user_profiles
WHERE user_id = 'your-user-id-here';
```

## Complete 2FA Setup Checklist

- [ ] `speakeasy` package installed
- [ ] `qrcode` package installed
- [ ] `/api/2fa/route.ts` exists
- [ ] Database has `two_factor_secret`, `two_factor_enabled`, `backup_codes` columns
- [ ] User profile exists in database
- [ ] Authenticator app installed on phone
- [ ] QR code displays properly
- [ ] Codes generate in authenticator app
- [ ] Verification works

## Using Backup Codes

If you lose access to your authenticator app:

1. You should have saved 10 backup codes during setup
2. View them in your account settings (if 2FA is enabled)
3. Use ONE backup code to log in
4. Each backup code can only be used once
5. After using, generate new backup codes

## Security Notes

- **Never share your secret** - if someone gets it, they can generate valid codes
- **Keep backup codes safe** - they bypass 2FA
- **One-time use** - backup codes can't be reused
- **Regenerate if compromised** - if you think someone has your codes

## Need Help?

If you're still not receiving codes:
1. **Verify you have an authenticator app installed**
2. **Check the browser console for errors**
3. **Test the API endpoint directly**
4. **Check database to see if secret was stored**

Remember: Codes are NOT sent via email/SMS - they're generated by your authenticator app!

